<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Tee Sheet Generator (Mobile Fixed)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 12px; }
  h1 { text-align:center; font-size:1.8em; }

  .player-list { 
    max-height: 300px; 
    overflow-y: auto; 
    border:1px solid #ccc; 
    padding:8px; 
    margin-bottom:10px; 
  }

  .player-item {
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    margin-bottom: 6px;
    padding: 4px 6px;
    border-bottom: 1px solid #eee;
  }
  .player-item .player-name {
    flex: 1 1 150px; 
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .player-item .yes-col {
    width: 60px; 
    display: flex;
    align-items: center;
    gap: 4px;
  }

  #output { 
    white-space: pre-wrap; 
    border:1px solid #ccc; 
    padding:10px; 
    margin-top:12px; 
    font-size: 0.95em;
  }

  button { 
    padding:12px 16px; 
    margin:4px 4px 4px 0; 
    font-size:16px; 
    border-radius:8px;
    cursor:pointer;
  }

  textarea { 
    width:100%; 
    font-family: monospace; 
    font-size: 1em; 
    margin-bottom:8px;
  }

  input, select { font-size:1em; padding:4px; }

  @media (max-width: 480px) {
    .player-item .player-name { flex: 1 1 100%; }
    .player-item .yes-col { width: 100%; margin-top: 4px; }
    button { width: 100%; margin-bottom: 6px; }
  }
</style>
</head>
<body>
<h1>Tee Sheet Generator</h1>

<div style="margin-bottom:10px">
  <label>Start Time: 
    <input type="time" id="startTime" value="08:00">
  </label>
  <label>Playing Format: 
    <select id="pFormat">
      <option value="">-- Select Format --</option>
      <option value="Individual">Individual</option>
      <option value="Secret Pairs">Secret Pairs</option>
      <option value="Best 3 from 4">Best 3 from 4</option>
    </select>
  </label>
</div>

<h3>Enter Players (one per line)</h3>
<textarea id="playerTextarea" rows="10" placeholder="Paste your player names here..."></textarea>
<button id="loadBtn" type="button">Load Players</button>

<h3>Select Players</h3>
<div class="player-list" id="playerList"></div>

<div>
  <button id="genBtn" type="button">Generate Tee Times</button>
  <button id="copyBtn" type="button">Copy to WhatsApp</button>
  <button id="clearBtn" type="button">Clear Selections</button>
</div>

<div id="output"></div>

<script>
let players = [];
let generatedText = "";

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loadBtn').addEventListener('click', loadPlayers);
  document.getElementById('genBtn').addEventListener('click', generateTeeTimes);
  document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
  document.getElementById('clearBtn').addEventListener('click', clearSelections);
  loadFromLocalStorage();
});

// --- Load players (mobile-safe) ---
function loadPlayers() {
  const textarea = document.getElementById('playerTextarea');
  const text = (textarea.value || '').trim();
  if (!text) {
    alert("Please enter at least one player.");
    return;
  }

  // Hide the keyboard first
  textarea.blur();

  // Wait a short moment for mobile browsers to repaint
  setTimeout(() => {
    players = text.split(/\r?\n/).map(p => p.trim()).filter(p => p.length > 0);

    const playerListDiv = document.getElementById('playerList');
    playerListDiv.innerHTML = '';

    players.forEach((p,i) => {
      const div = document.createElement('div');
      div.className = 'player-item';
      div.innerHTML = `
        <div class="player-name"><input type="checkbox" id="play${i}"> ${p}</div>
        <div class="yes-col"><label><input type="checkbox" id="yes${i}"> Yes</label></div>
      `;
      playerListDiv.appendChild(div);
    });

    attachCheckboxListeners();
    saveToLocalStorage();
    generatedText = '';
    document.getElementById('output').textContent = '';
  }, 200); // short delay = smooth mobile update
}

function attachCheckboxListeners(){
  players.forEach((p,i)=>{
    document.getElementById(`play${i}`).addEventListener('change', saveToLocalStorage);
    document.getElementById(`yes${i}`).addEventListener('change', saveToLocalStorage);
  });
}

function clearSelections() {
  players.forEach((p,i)=>{
    const playCheckbox = document.getElementById(`play${i}`);
    const yesCheckbox = document.getElementById(`yes${i}`);
    if(playCheckbox) playCheckbox.checked = false;
    if(yesCheckbox) yesCheckbox.checked = false;
  });
  generatedText = '';
  document.getElementById('output').textContent = '';
  saveToLocalStorage();
}

function saveToLocalStorage() {
  const data = {
    playersText: document.getElementById('playerTextarea').value,
    playChecked: players.map((p,i)=>document.getElementById(`play${i}`)?.checked || false),
    yesChecked: players.map((p,i)=>document.getElementById(`yes${i}`)?.checked || false),
    startTime: document.getElementById('startTime').value,
    pFormat: document.getElementById('pFormat').value
  };
  localStorage.setItem('teeSheetData', JSON.stringify(data));
}

function loadFromLocalStorage() {
  const data = JSON.parse(localStorage.getItem('teeSheetData') || '{}');
  if(data.playersText){
    document.getElementById('playerTextarea').value = data.playersText;
    loadPlayers();
    setTimeout(() => {
      players.forEach((p,i)=>{
        if(data.playChecked && data.playChecked[i] !== undefined)
          document.getElementById(`play${i}`).checked = data.playChecked[i];
        if(data.yesChecked && data.yesChecked[i] !== undefined)
          document.getElementById(`yes${i}`).checked = data.yesChecked[i];
      });
      if(data.startTime) document.getElementById('startTime').value = data.startTime;
      if(data.pFormat) document.getElementById('pFormat').value = data.pFormat;
    }, 300);
  }
}

// --- Group + tee time generation ---
function computeGroupSizes(totalPlayers){
  const maxFours = Math.floor(totalPlayers / 4);
  for(let k=maxFours;k>=0;k--){
    const rem = totalPlayers - 4*k;
    if(rem>=0 && rem%3===0){
      const sizes=[];
      for(let i=0;i<rem/3;i++) sizes.push(3);
      for(let i=0;i<k;i++) sizes.push(4);
      return sizes;
    }
  }
  return null;
}

function generateTeeTimes(){
  const selected=[], yesPlayers=[], invalidYes=[];
  players.forEach((p,i)=>{
    const playChecked = document.getElementById(`play${i}`).checked;
    const yesChecked = document.getElementById(`yes${i}`).checked;
    if(playChecked) selected.push(p);
    if(yesChecked) {
      if(playChecked) yesPlayers.push(p);
      else invalidYes.push(p);
    }
  });

  if(invalidYes.length>0){ alert("⚠️ The following players are marked 'Yes' but not selected to play:\n\n"+invalidYes.join(", ")); return;}
  if(selected.length<3){ alert('At least 3 players required.'); return;}

  const groupSizes = computeGroupSizes(selected.length);
  if(!groupSizes){ alert('Unable to build 3/4 groups for '+selected.length+' players.'); return;}

  const remainingPlayers = selected.filter(p => !yesPlayers.includes(p));
  for(let i=remainingPlayers.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [remainingPlayers[i],remainingPlayers[j]]=[remainingPlayers[j],remainingPlayers[i]];
  }

  const totalGroups = groupSizes.length;
  const groupFill = Array.from({length:totalGroups},()=>[]);

  if(yesPlayers.length>0){
    let placed=false;
    for(let g=0;g<totalGroups;g++){
      if(groupSizes[g]>=yesPlayers.length){
        yesPlayers.forEach(y=>groupFill[g].push(y));
        placed=true; break;
      }
    }
    if(!placed){
      let g=0,yIdx=0;
      while(yIdx<yesPlayers.length && g<totalGroups){
        while(groupFill[g].length<groupSizes[g] && yIdx<yesPlayers.length) groupFill[g].push(yesPlayers[yIdx++]);
        g++;
      }
    }
  }

  let remIdx=0;
  for(let g=0;g<totalGroups;g++){
    while(groupFill[g].length<groupSizes[g] && remIdx<remainingPlayers.length) groupFill[g].push(remainingPlayers[remIdx++]);
  }

  const [h,m]=document.getElementById('startTime').value.split(':').map(Number);
  const firstTee=new Date(); firstTee.setHours(h,m,0,0);

  let out='Time | Group | Players\n------------------------\n';
  for(let g=0;g<totalGroups;g++){
    const tee=new Date(firstTee.getTime()+g*8*60000);
    out+=`${String(tee.getHours()).padStart(2,'0')}:${String(tee.getMinutes()).padStart(2,'0')} | Group ${g+1} | ${groupFill[g].join(', ')}\n`;
  }

  const pFormat=document.getElementById('pFormat').value||'';
  if(pFormat) out+=`\nPlaying Format: ${pFormat}`;

  const n3 = groupSizes.filter(s=>s===3).length;
  const n4 = groupSizes.filter(s=>s===4).length;
  out+=`\n3-balls: ${n3}   4-balls: ${n4}`;

  generatedText=out;
  document.getElementById('output').textContent=out;
  saveToLocalStorage();
}

function copyToClipboard(){
  if(!generatedText){ alert('Generate tee times first'); return; }
  navigator.clipboard.writeText(generatedText).then(()=>{ alert('✅ Tee times copied — paste into WhatsApp.'); }, ()=>{ alert('Clipboard not supported on this device.'); });
}
</script>
</body>
</html>
